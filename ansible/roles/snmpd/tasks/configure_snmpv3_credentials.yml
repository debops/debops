---

- name: Stop snmpd before admin account initialization
  service:
    name: 'snmpd'
    state: 'stopped'

- name: Prepare admin account
  lineinfile:
    dest: '/var/lib/snmp/snmpd.conf'
    regexp: '^createUser {{ snmpd_fact_account_admin_username }}'
    line: 'createUser {{ snmpd_fact_account_admin_username }} SHA "{{ snmpd_fact_account_admin_password }}" AES'
    state: 'present'
  no_log: True

- name: Start snmpd to initialize admin account
  service:
    name: 'snmpd'
    state: 'started'

- name: Create read-only agent account
  command: snmpusm -u {{ snmpd_fact_account_admin_username }} -l authPriv -a SHA -x AES
           -A "{{ snmpd_fact_account_admin_password }}"
           -X "{{ snmpd_fact_account_admin_password }}" localhost
           create {{ snmpd_fact_account_agent_username }} {{ snmpd_fact_account_admin_username }}
  changed_when: False
  no_log: True

- name: Change agent account password
  command: snmpusm -u {{ snmpd_fact_account_admin_username }} -l authPriv -a SHA -x AES
           -A "{{ snmpd_fact_account_admin_password }}"
           -X "{{ snmpd_fact_account_admin_password }}" localhost
           passwd "{{ snmpd_fact_account_admin_password }}" "{{ snmpd_fact_account_agent_password }}"
           {{ snmpd_fact_account_agent_username }}
  changed_when: False
  no_log: True

- name: Create read-only local account
  command: snmpusm -u {{ snmpd_fact_account_admin_username }} -l authPriv -a SHA -x AES
           -A "{{ snmpd_fact_account_admin_password }}"
           -X "{{ snmpd_fact_account_admin_password }}" localhost
           create {{ snmpd_account_local_username }} {{ snmpd_fact_account_admin_username }}
  changed_when: False
  no_log: True

- name: Change local account password
  command: snmpusm -u {{ snmpd_fact_account_admin_username }} -l authPriv -a SHA -x AES
           -A "{{ snmpd_fact_account_admin_password }}"
           -X "{{ snmpd_fact_account_admin_password }}" localhost
           passwd "{{ snmpd_fact_account_admin_password }}" "{{ snmpd_account_local_password }}"
           {{ snmpd_account_local_username }}
  changed_when: False
  no_log: True

- name: Remove admin account from snmpd.conf
  lineinfile:
    dest: '/etc/snmp/snmpd.conf'
    regexp: '^rwuser\s+{{ snmpd_fact_account_admin_username }}\s+priv'
    state: 'absent'
  no_log: True
