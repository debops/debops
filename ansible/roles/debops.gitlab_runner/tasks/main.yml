- set_fact:
    # One of the runner is using docker
    with_docker: "{{ gitlab_runner__configuration.runners | map(attribute='docker') | select('defined') | list | count > 0 }}"
    # One of the runner is for GitLab.com
    with_gitlab_com: "{{ gitlab_runner__configuration.runners | map(attribute='url') | select('in', 'https://gitlab.com/') | list | count > 0 }}"
    with_custom_cert: "{{ gitlab_runner__configuration.runners | map(attribute='tls-key-file') | select('defined') | list | count > 0 }}"

- import_tasks: 05-install.yml
  when: install | default(True) | bool
  tags: [apt, user]

- import_tasks: 10-cert.yml
  # If at least one tls-key-file is set
  when: with_custom_cert | bool
  tags: cert

# Note: GITLAB_TOKEN environment variable needs to be set
- import_tasks: 50-register-runners.yml
  no_log: true
  tags: register

- name: Generate GitLab Runner configuration files
  copy:
    content: "{{ gitlab_runner__configuration | to_toml }}"
    dest: /etc/gitlab-runner/config.toml
    owner: root
    group: root
    mode: 0600
  become: yes
  no_log: yes
  # If at least one token has been substitued
  when: registered_runner is defined and (gitlab_runner__configuration.runners | first).token | string | length > 10
  notify: gitlab-runner-restart

- name: Install ssh keys of GitLab.com
  known_hosts:
    hash_host: False
    name: '{{ item.h }}'
    key: '{{ item.k }}'
    path: /etc/ssh/ssh_known_hosts
  with_items:
    - { h: gitlab.com, k: 'gitlab.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAfuCHKVTjquxvt6CM6tdG4SLp1Btn/nOeHHE5UOzRdf' }
    - { h: gitlab.com, k: 'gitlab.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFSMqzJeV9rUzU4kWitGjeR4PWSa29SPqJ1fVkhtj3Hw9xjLVXVYrU9QlYWrOLXBpQ6KWjbjTDTdDkoohFzgbEY=' }
  when: with_gitlab_com | bool | default(True)
  tags: ssh
