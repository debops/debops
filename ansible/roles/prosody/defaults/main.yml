---
# .. vim: foldmarker=[[[,]]]:foldmethod=marker

# .. Copyright (C) 2018 Norbert Summer <git@o-g.at>
# .. Copyright (C) 2020 Rainer 'rei' Schuth <devel@reixd.net>
# .. Copyright (C) 2018 DebOps <https://debops.org/>
# .. SPDX-License-Identifier: GPL-3.0-only

# .. _prosody__ref_defaults:

# debops.prosody default variables [[[
# ====================================

# .. contents:: Sections
#    :local:
#
# .. include:: ../../../../includes/global.rst


# Packages and installation [[[
# -----------------------------

# .. envvar:: prosody__base_packages [[[
#
# List of base packages to install.
prosody__base_packages:
  - 'prosody'
  - 'lua-zlib'
  - 'lua-sec'
  - 'prosody-modules'  # for ldap auth
  - '{{ "lua-event" if prosody__use_libevent|bool else [] }}'

                                                                   # ]]]
# .. envvar:: prosody__packages [[[
#
# List of additional APT packages to install with Prosody.
prosody__packages: []
                                                                   # ]]]
                                                                   # ]]]
# PKI [[[
# -------

# .. envvar:: prosody__pki [[[
#
# Enable or disable support for PKI/SSL/TLS in prosody.
# Defaults to ``True`` if :ref:`debops.pki` is enabled on the remote host.
prosody__pki: '{{ ansible_local|d() and ansible_local.pki|d() and
               (ansible_local.pki.enabled|d() | bool) }}'

                                                                   # ]]]
# .. envvar:: prosody__pki_realm_path [[[
#
# Directory path where PKI realm live.
prosdoy__pki_realm_path: '{{ ansible_local.pki.path
                            if (ansible_local|d() and ansible_local.pki|d() and
                                ansible_local.pki.path|d())
                            else "/etc/pki/realms" }}'

                                                                   # ]]]
# .. envvar:: prosody__pki_realm [[[
#
# Default PKI realm to use.
prosody__pki_realm: '{{ ansible_local.pki.realm
                       if (ansible_local|d() and ansible_local.pki|d() and
                           ansible_local.pki.realm|d())
                       else "domain" }}'

                                                                   # ]]]
# .. envvar:: prosody__pki_crt_filename [[[
#
# Default CRT file name to use.
prosody__pki_crt_filename: '{{ ansible_local.pki.crt
                              if (ansible_local|d() and ansible_local.pki|d() and
                                  ansible_local.pki.crt|d())
                              else "default.crt" }}'

                                                                   # ]]]
# .. envvar:: prosody__pki_key_filename [[[
#
# Default private key file name to use.
prosody__pki_key_filename: '{{ ansible_local.pki.key
                              if (ansible_local|d() and ansible_local.pki|d() and
                                  ansible_local.pki.key|d())
                              else "default.key" }}'

                                                                   # ]]]
# .. envvar:: prosody__pki_hook_name [[[
#
# Name of the hook script which will be stored in hook directory.
prosody__pki_hook_name: 'prosody'

                                                                   # ]]]
# .. envvar:: prosody__pki_hook_path [[[
#
# Directory with PKI hooks.
prosody__pki_hook_path: '{{ ansible_local.pki.hooks
                         if (ansible_local|d() and ansible_local.pki|d() and
                             ansible_local.pki.hooks|d())
                         else "/etc/pki/hooks" }}'

                                                                   # ]]]
# .. envvar:: prosody__pki_hook_action [[[
#
# Specify how changes in PKI should affect prosody, either 'reload' or 'restart'.
prosody__pki_hook_action: 'reload'
                                                                   # ]]]
                                                                   # ]]]
# Prosody Configuration [[[
# -------------------------

# .. envvar:: prosody__deploy_state [[[
#
# Set to `absent` to disable and uninstall this role
prosody__deploy_state: "present"

                                                                   # ]]]
# .. envvar:: prosody__domain [[[
#
# The hosts's DNS domain name used in the Prosody configuration.
prosody__domain: '{{ ansible_local.core.domain
                     if (ansible_local|d() and ansible_local.core|d() and
                         ansible_local.core.domain|d())
                     else ansible_domain }}'

                                                                   # ]]]
# .. envvar:: prosody__admins [[[
#
# List of admin jabber accounts of this prosody instance
prosody__admins: []

                                                                   # ]]]
# .. envvar:: prosody__use_libevent [[[
#
# Set this to true to enable the libevent backend
# @see https://prosody.im/doc/libevent
prosody__use_libevent: false

                                                                   # ]]]
# .. envvar:: prosody__modules_default [[[
#
# Modules that are loaded by default
# @see https://prosody.im/doc/configure
prosody__modules_default:
  - "roster"
  - "saslauth"
  - "tls"
  - "dialback"
  - "disco"
  - "private"
  - "vcard"
  - "privacy"  #@TODO check version < 0.10
  - "compression"
  - "version"
  - "uptime"
  - "time"
  - "ping"
  - "pep"
  - "admin_adhoc"
  - "posix"
  - "groups"
  - "carbons"
  - "mam"
  - "blocking"
  - "smacks"
  #- "s2s_auth_dane"

                                                                   # ]]]
# .. envvar:: prosody__modules [[[
#
# Modules that should be enabled
prosody__modules: '{{ prosody__modules_default }}'

                                                                   # ]]]
# .. envvar:: prosody__authentication [[[
#
# Providers:
#  - internal_hashed [default]
#  - internal_plain
#  - cyrus
#  - anonymous
#  - ldap2 (TODO)
#
# https://prosody.im/doc/authentication
prosody__authentication: 'internal_hashed'

                                                                   # ]]]
# .. envvar:: prosody__insecure_domains [[[
#
# List of insecure domains. As example `gmail.com`
# https://prosody.im/doc/s2s
prosody__insecure_domains: []

                                                                   # ]]]
# .. envvar:: prosody__allow_registration [[[
#
# Allow new registrations
prosody__allow_registration: False

                                                                   # ]]]
# .. envvar:: prosody__config_ldap [[[
#
# LDAP config, this is used when `prosody__authentication` is ldap2.
# https://modules.prosody.im/mod_auth_ldap2.html
prosody__config_ldap:
  ldap:
    hostname: 'ldap.{{ ansible_domain }}'
    user:
      basedn: 'ou=users,..@TODO'
      usernamefield: 'uid'
    bind_dn: 'uid=....,dc=...@TODO'
    bind_password: 'lookup..@TODO'
    use_tls: True

                                                                   # ]]]
# .. envvar:: prosody__default_config_global [[[
#
# Main prosody configuration, default values
# @see https://prosody.im/doc/configure
prosody__default_config_global:
  admins: '{{ prosody__admins }}'
  modules_enabled: '{{ prosody__modules }}'
  allow_registration: '{{ prosody__allow_registration }}'
  daemonize: True
  pidfile: "/var/run/prosody/prosody.pid"
  use_libevent: '{{ prosody__use_libevent }}'
  c2s_require_encryption: True
  s2s_require_encryption: True
  s2s_secure_auth: True
  s2s_insecure_domains: '{{ prosody__insecure_domains }}'
  authentication: '{{ prosody__authentication }}'
  log:
    info: "/var/log/prosody/prosody.log"
    error: "/var/log/prosody/prosody.err"

                                                                   # ]]]
# .. envvar:: prosody__config_http_server [[[
#
# HTTP server specific settings.
# More infos at https://prosody.im/doc/http
prosody__config_http_server:
  http_port:
    - 5280
  http_interface:
    - '*'
  https_port:
    - 5281
  https_interface:
    - '*'
  https_ssl:
    certificate: '{{ prosdoy__pki_realm_path + "/" + prosody__pki_realm + "/" + prosody__pki_crt_filename }}'
    key: '{{ prosdoy__pki_realm_path + "/" + prosody__pki_realm + "/" + prosody__pki_key_filename }}'

                                                                   # ]]]
# .. envvar:: prosody__config_gloabl [[[
#
# Mapping for global configs which will be managed on all hosts in the Ansible
# inventory.
prosody__config_global: {}

                                                                   # ]]]
# .. envvar:: prosody__group_config_gloabl [[[
#
# Mapping for global configs which will be managed on specific groups in the Ansible
# inventory.
prosody__group_config_global: {}

                                                                   # ]]]
# .. envvar:: prosody__host_config_gloabl [[[
#
# Mapping for global configs which will be managed on specific hosts in the Ansible
# inventory.
prosody__host_config_global: {}

                                                                   # ]]]
# .. envvar:: prosody__combined_config_gloabl [[[
#
# Mapping which combines all of the global config variables and is used
# in the configuration template.
prosody__combined_config_global: '{{ prosody__default_config_global
                                     | combine(prosody__config_http_server,
                                               prosody__config_ldap
                                                 if prosody__authentication == "ldap2" else {},
                                               prosody__config_global,
                                               prosody__group_config_global,
                                               prosody__host_config_global ) }}'

                                                                   # ]]]

# Virtual Host Configuration [[[
# ----------------------------------------

# You need to add a VirtualHost entry for each domain you wish Prosody to serve.
# Settings under each VirtualHost entry apply *only* to that host.
#
# For more information, check `Virtual host settings <https://prosody.im/doc/configure#virtual_host_settings>`_.

# Each virtual host in the list can have the following parameters:
#
# .. code-block:: yaml
#  :linenos:
#
#  prosody__virtual_hosts:
#    - name: 'example.com'
#      enabled: True
#      pki_realm: 'xmpp.example.com'
#      # optional settings
#      tls_crt: '/path/to/cert.pem'
#      tls_key: '/path/to/key.pem'
#      modules_enabled:
#        - 'module1'
#        - 'module2'
#      modules_disabled:
#        - 'another_module'
#      admins:
#        - alice@example.com
#      authentication: 'internal_hashed'
#
#    - name: 'another-domain.net'
#      enabled: True
#      pki_realm: 'chat.another-domain.net'
#

# .. envvar:: prosody__default_virtual_hosts [[[
#
# Variable which contains default virtual hosts used by prosody
prosody__default_virtual_hosts:
  - name: '{{ ansible_domain }}'
    enabled: false
    pki_realm: 'domain'

                                                                   # ]]]

# .. envvar:: prosody__virtual_hosts [[[
#
# Variable which contains virtual hosts used by prosody configured on all hosts
# in the Ansible inventory.
prosody__virtual_hosts: []

                                                                   # ]]]

# .. envvar:: prosody__group_virtual_hosts [[[
#
# Variable which contains virtual hosts used by prosody configured on hosts in
## specific Ansible inventory group.
prosody__group_virtual_hosts: []

                                                                   # ]]]

# .. envvar:: prosody__host_virtual_hosts [[[
#
# Variable which contains virtual hosts used by prosody configured on specific
## hosts in the Ansible inventory.
prosody__host_virtual_hosts: []

                                                                   # ]]]

# .. envvar:: prosody__dependent_virtual_hosts [[[
#
# The variable which can be used by other Ansible roles to define additional
# Virtual Hosts that should be present in the Prosody server.
prosody__dependent_virtual_hosts: []

                                                                   # ]]]

# .. envvar:: prosody__combined_virtual_hosts [[[
#
# Variable which contains virtual hosts used by prosody,, combined from all other
# variables.
prosody__combined_virtual_hosts: '{{ (prosody__default_virtual_hosts
                                     + prosody__virtual_hosts
                                     + prosody__group_virtual_hosts
                                     + prosody__host_virtual_hosts
                                     + prosody__dependent_virtual_hosts)|
                                       parse_kv_items() }}'

                                                                   # ]]]
                                                                   # ]]]

# Component Configuration [[[
# ----------------------------------------

# Components are extra services on a server which are available to clients,
# usually on a subdomain of the main server (such as mycomponent.example.com).
# Example components might be chatroom servers, user directories, or gateways to other protocols.
#
# For more information, check `Components in Prosody <https://prosody.im/doc/components>`_.
#
# Each Component in the list can have the following parameters:
#
# .. code-block:: yaml
#   :linenos:
#
#   prosody__components:
#     - name: 'conference.{{ prosody__domain }}'
#       enabled: true
#       # optional settings
#       plugin_name: 'muc'
#       modules_enabled:
#         - module1
#         - storage:
#             muc_log: 'sql'
#       params:
#         key1: value1
#         key2: value2
#         component_secret: 's3cr3t'
#         component_interface: '{{ ansible_default_ipv4.address|d() }}'
#         component_ports: [ '4242' ]

# .. envvar:: prosody__default_components [[[
#
# Variable which contains default components used by prosody
prosody__default_components:
  #  muc (multi user channel) config for group channel function.
  #  https://prosody.im/doc/modules/mod_muc
  #  XEP-0045
  - name: 'conference.{{ prosody__domain }}'
    enabled: true
    plugin_name: 'muc'
    modules_enabled: []
    params: {}

  #  http_upload enables upload via http(s) for clients to share files
  #  https://modules.prosody.im/mod_http_upload.html
  #  XEP-0363
  - name: 'upload.{{ prosody__domain }}'
    enabled: true
    plugin_name: 'http_upload'
    modules_enabled: []
    params: {}
                                                                   # ]]]

# .. envvar:: prosody__components [[[
#
# Variable which contains components used by prosody configured on all hosts
# in the Ansible inventory.
prosody__components: []

                                                                   # ]]]

# .. envvar:: prosody__group_components [[[
#
# Variable which contains components used by prosody configured on hosts in
## specific Ansible inventory group.
prosody__group_components: []

                                                                   # ]]]

# .. envvar:: prosody__host_components [[[
#
# Variable which contains components used by prosody configured on specific
## hosts in the Ansible inventory.
prosody__host_components: []

                                                                   # ]]]

# .. envvar:: prosody__dependent_components [[[
#
# The variable which can be used by other Ansible roles to define additional
# Components that should be present in the Prosody server.
prosody__dependent_components: []

                                                                   # ]]]

# .. envvar:: prosody__combined_components [[[
#
# Variable which contains components used by prosody,, combined from all other
# variables.
prosody__combined_components: '{{ (prosody__default_components
                                   + prosody__components
                                   + prosody__group_components
                                   + prosody__host_components
                                   + prosody__dependent_components)|
                                      parse_kv_items() }}'

                                                                   # ]]]
                                                                   # ]]]

# Configuration for other Ansible roles [[[
# ----------------------------------------

# .. envvar:: prosody__ferm__dependent_rules [[[
#
# Configuration for :command:`iptables` firewall manged by :program:`ferm`.
prosody__ferm__dependent_rules:

  - type: 'accept'
    dport: [ '5222' ]
    accept_any: True
    weight: '40'
    by_role: 'prosody'
    name: 'prosody-xmpp-client'
    multiport: True
    rule_state: '{{ prosody__deploy_state }}'
  - type: 'accept'
    dport: [ '5269' ]
    accept_any: True
    weight: '40'
    by_role: 'prosody'
    name: 'prosody-xmpp-server'
    multiport: True
    rule_state: '{{ prosody__deploy_state }}'
  - type: 'accept'
    dport: [ '5280', '5281' ]
    accept_any: True
    weight: '40'
    by_role: 'prosody'
    name: 'prosody-http'
    multiport: True
    rule_state: '{{ prosody__deploy_state }}'
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
