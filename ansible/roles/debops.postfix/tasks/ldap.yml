---

- name: Make sure required system accounts exist
  user:
    name: '{{ item.name }}'
    state: 'present'
    comment: '{{ item.comment | d("Postfix Virtual Mail user") }}'
    group: '{{ item.group | d(item.name) }}'
    home: '{{ item.home }}'
    create_home: '{{ item.create_home | d(True)) | bool }}'
    system: '{{ (item.system | d(True)) | bool }}'
    shell: '{{ item.shell | d("/usr/sbin/nologin") }}'
    skeleton: '{{ item.skeleton | d(null) }}'
  with_flattened:
    - '{{ postfix__ldap_system_users }}'
  when: 'item.state|d("present") != "absent" and item.name|d() and item.home|d()'

- name: "Make sure vmail home directory ({{ postfix__virtual_mailbox_base }}) exists with restrictive permissions"
  file:
    dest: '{{ postfix__virtual_mailbox_base }}'
    state: 'directory'
    owner: '{{ postfix__virtual_mail_posix_user }}'
    group: '{{ postfix__virtual_mail_posix_group }}'
    mode: '0750'

- name: Get vmail getent group info
  getent:
    database: 'group'
    split: ':'
    key: '{{ postfix__virtual_mail_posix_group }}'

- name: Get vmail getent passwd info
  getent:
    database: 'passwd'
    split: ':'
    key: '{{ postfix__virtual_mail_posix_user }}'

- name: Make sure 'postfix/ldap' directory exists
  file:
    dest: '/etc/postfix/ldap'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0755'

- name: Generate LDAP virtual files
  template:
    src:   'ldap/postfix__{{ item }}.j2'
    dest:  '/etc/postfix/ldap/{{ item }}.cf'
    owner: 'postfix'
    group: 'postfix'
    mode:  '0400'
  loop:
    - 'virtual_aliases'
    - 'virtual_recipients'
    - 'virtual_domains'
    - 'virtual_senders'
  no_log: '{{ postfix__no_log|d(True) }}'
#
#Create a System User To Handle Virtual Mail Directories
#-------------------------------------------------------
#
#* Virtual users are those that don’t technically exist on your Linux server, and they don’t use the standard Linux methods for authentication or mail delivery and storage.
#* Your mail server virtual user accounts are defined within the database created by Postfix Admin rather than existing as system user accounts.*
#* So we have to create a single system user account that will handle services like mail storage and Dovecot authentication.
#
#* First, let’s create a system user account called vmail and give it permissions to the required directories.
#* This system account will be responsible for the backend operations for mailbox storage and services.


#* Add a system user and group named vmail with uid and gid 5000:
#* Make sure that /var/vmail has been created.
#
#
#useradd -r -u 150 -g mail -d /var/vmail -s /sbin/nologin -c "Virtual MailDir Handler" vmail
#mkdir -p /var/vmail
#chown vmail:mail /var/vmail
#chmod 770 /var/vmail
#

#addgroup --system --gid 5000 vmail
#adduser --system --home /var/vmail --uid 5000 --gid 5000 --disabled-password --disabled-login -c "Virtual MailDir Handler" vmail
#mkdir -p /var/vmail
#chown -R vmail:vmail /var/vmail
#chmod -R 770 /var/vmail
