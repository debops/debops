---
# .. vim: foldmarker=[[[,]]]:foldmethod=marker

# .. _postfix__ref_defaults:

# debops.postfix default variables [[[
# ====================================

# .. contents:: Sections
#    :local:
#
# .. include:: ../../../../includes/global.rst


# APT packages, version [[[
# -------------------------

# .. envvar:: postfix__base_packages [[[
#
# List of the default APT packages to install for Postfix support.
postfix__base_packages: [ 'postfix', 'postfix-pcre', 'bsd-mailx', 'make',
                          'ssl-cert', 'ca-certificates' ]

                                                                   # ]]]
# .. envvar:: postfix__ldap_packages [[[
#
# List of additional APT packages needed for the LDAP support.
postfix__ldap_packages: '{{ [ "postfix-ldap" ] if postfix__ldap_enabled else [] }}'

                                                                   # ]]]
# .. envvar:: postfix__dependent_packages [[[
#
# List of additional APT packages requested by other Ansible roles via role
# dependent variables.
postfix__dependent_packages: []

                                                                   # ]]]
# .. envvar:: postfix__packages [[[
#
# List of additional APT packages to install with Postfix.
postfix__packages: []

                                                                   # ]]]
# .. envvar:: postfix__purge_packages [[[
#
# List of APT packages to purge when Postfix is installed, to remove the
# remnants of other SMTP services.
postfix__purge_packages: [ 'exim4-base', 'exim4-config',
                           'exim4-daemon-light', 'nullmailer' ]

                                                                   # ]]]
# .. envvar:: postfix__version [[[
#
# The currently installed Postfix version. This variable is defined by the
# Ansible local facts and it's here for convenience, shouldn't be set manually.
postfix__version: '{{ ansible_local.postfix.version
                      if (ansible_local|d() and ansible_local.postfix|d() and
                          ansible_local.postfix.version|d())
                      else "0.0.0" }}'

                                                                   # ]]]
# .. envvar:: postfix__doc_installed [[[
#
# The ``postfix-doc`` APT package modifies the :file:`/etc/postfix/main.cf`
# configuration file directly, therefore the role takes its presence into
# account during configuration. The package presence is checked by the Ansible
# local facts.
postfix__doc_installed: '{{ ansible_local.postfix.doc_installed
                            if (ansible_local|d() and ansible_local.postfix|d() and
                                ansible_local.postfix.doc_installed is defined)
                            else False }}'
                                                                   # ]]]
                                                                   # ]]]
# DNS, mail next-hop configuration [[[
# ------------------------------------

# .. envvar:: postfix__fqdn [[[
#
# The host's Fully Qualified Domain Name used in the Postfix configuration.
postfix__fqdn: '{{ ansible_local.core.fqdn
                   if (ansible_local|d() and ansible_local.core|d() and
                       ansible_local.core.fqdn|d())
                   else ansible_fqdn }}'

                                                                   # ]]]
# .. envvar:: postfix__domain [[[
#
# The host's DNS domain name used in the Postfix configuration.
postfix__domain: '{{ ansible_local.core.domain
                     if (ansible_local|d() and ansible_local.core|d() and
                         ansible_local.core.domain|d())
                     else ansible_domain }}'

                                                                   # ]]]
# .. envvar:: postfix__relayhost [[[
#
# Next-hop destination of non-local mail.
postfix__relayhost: ''

                                                                   # ]]]
# .. envvar:: postfix__mailname [[[
#
# The name of this mail system, configured in :file:`/etc/mailname` file. This
# name is used as the domain part in sender mail addresses that don't have one.
# See https://wiki.debian.org/EtcMailName for more details.
postfix__mailname: '{{ postfix__domain }}'
                                                                   # ]]]
                                                                   # ]]]
# Firewall configuration [[[
# --------------------------

# .. envvar:: postfix__accept_any [[[
#
# Specofy the default firewall policy for Postfix services.
#
# If ``True``, any host can connect to the Postfix services unless allow
# restrictions are defined using the variables below.
#
# If ``False``, no hosts can connect to the Postfix services by default. You
# need to specify IP addresses or subnets that can access the services using
# the variables below.
postfix__accept_any: True

                                                                   # ]]]
# .. envvar:: postfix_allow_smtp [[[
#
# List of hosts/networks that can access the ``smtp`` port (25).
postfix__allow_smtp: []

                                                                   # ]]]
# .. envvar:: postfix_allow_submission [[[
#
# List of hosts/networks that can access the ``submission`` port (587).
postfix__allow_submission: []

                                                                   # ]]]
# .. envvar:: postfix_allow_smtps [[[
#
# List of hosts/networks that can access the ``smtps`` port (465).
postfix__allow_smtps: []
                                                                   # ]]]
                                                                   # ]]]
# PKI / TLS configuration [[[
# ---------------------------

# .. envvar:: postfix__pki [[[
#
# Enable or disable support for TLS in Postfix, managed by the :ref:`debops.pki`
# Ansible role.
postfix__pki: '{{ (True
                   if (ansible_local|d() and ansible_local.pki|d() and
                       ansible_local.pki.enabled|d() | bool)
                   else False) | bool }}'

                                                                   # ]]]
# .. envvar:: postfix__pki_path [[[
#
# Absolute path to the directory where PKI realms are located.
postfix__pki_path: '{{ ansible_local.pki.path
                       if (ansible_local|d() and ansible_local.pki|d() and
                           ansible_local.pki.path|d())
                       else "/etc/pki/realms" }}'

                                                                   # ]]]
# .. envvar:: postfix__pki_realm [[[
#
# Name of the default PKI realm used by Postfix.
postfix__pki_realm: '{{ ansible_local.pki.realm
                        if (ansible_local|d() and ansible_local.pki|d() and
                            ansible_local.pki.realm|d())
                        else "domain" }}'

                                                                   # ]]]
# .. envvar:: postfix__pki_ca [[[
#
# Name of the Root Certificate Authority certificate file used by Postfix,
# relative to the PKI realm directory.
postfix__pki_ca: '{{ ansible_local.pki.ca
                     if (ansible_local|d() and ansible_local.pki|d() and
                         ansible_local.pki.ca|d())
                     else "CA.crt" }}'

                                                                   # ]]]
# .. envvar:: postfix__pki_ca_crt [[[
#
# Filename of the root CA certificate used by the ``debops.postfix`` role
# to verify TLS connections to the LDAP server.
postfix__pki_ca_crt: '{{ postfix__pki_path + "/"
                       + postfix__pki_realm + "/"
                       + postfix__pki_ca }}                                                                   '

                                                                   # ]]]
# .. envvar:: postfix__pki_crt [[[
#
# Name of the certificate file used by Postfix, relative to the PKI realm
# directory.
postfix__pki_crt: '{{ ansible_local.pki.crt
                      if (ansible_local|d() and ansible_local.pki|d() and
                          ansible_local.pki.crt|d())
                      else "default.crt" }}'

                                                                   # ]]]
# .. envvar:: postfix__pki_key [[[
#
# Name of the private key file used by Postfix, relative to the PKI realm
# directory.
postfix__pki_key: '{{ ansible_local.pki.key
                      if (ansible_local|d() and ansible_local.pki|d() and
                          ansible_local.pki.key|d())
                      else "default.key" }}'

                                                                   # ]]]
# .. envvar:: postfix__tls_ca_file [[[
#
# Absolute path of the Root Certificate Authority certificate file used in the
# Postfix configuration. This file should also be present in the Postfix chroot
# directory.
postfix__tls_ca_file: '/etc/ssl/certs/ca-certificates.crt'

                                                                   # ]]]
# .. envvar:: postfix__tls_cert_file [[[
#
# Absolute path of the certificate file used in the Postfix configuration.
postfix__tls_cert_file: '{{ (postfix__pki_path + "/" + postfix__pki_realm + "/" + postfix__pki_crt)
                            if postfix__pki|bool else "/etc/ssl/certs/ssl-cert-snakeoil.pem" }}'

                                                                   # ]]]
# .. envvar:: postfix__tls_key_file [[[
#
# Absolute path of the private key file used in the Postfix configuration.
postfix__tls_key_file: '{{ (postfix__pki_path + "/" + postfix__pki_realm + "/" + postfix__pki_key)
                           if postfix__pki|bool else "/etc/ssl/private/ssl-cert-snakeoil.key" }}'
                                                                   # ]]]
                                                                   # ]]]
# Diffie-Hellman parameters [[[
# -----------------------------

# .. envvar:: postfix__dhparam [[[
#
# Enable or disable support for custom Diffie-Hellman parameters managed by the
# :ref:`debops.dhparam` Ansible role.
postfix__dhparam: '{{ ansible_local.dhparam.enabled
                      if (ansible_local|d() and ansible_local.dhparam|d() and
                          ansible_local.dhparam.enabled is defined)
                      else False }}'

                                                                   # ]]]
# .. envvar:: postfix__dhparam_set [[[
#
# Name of the Diffie-Hellman parameter set to use in Postfix configuration. See
# :ref:`debops.dhparam` Ansible role for more details.
postfix__dhparam_set: 'default'

                                                                   # ]]]
# .. envvar:: postfix__tls_dh1024_param_file [[[
#
# Absolute path to Diffie-Hellman parameters file which should be used for
# non-export grade connections.
postfix__tls_dh1024_param_file: '{{ ansible_local.dhparam[postfix__dhparam_set]
                                    if (ansible_local|d() and ansible_local.dhparam|d() and
                                        ansible_local.dhparam[postfix__dhparam_set]|d())
                                    else "" }}'

                                                                   # ]]]
# .. envvar:: postfix__tls_dh512_param_file [[[
#
# Absolute path to Diffie-Hellman parameters file which should be used for
# export grade connections.
postfix__tls_dh512_param_file: '{{ ansible_local.dhparam[postfix__dhparam_set]
                                   if (ansible_local|d() and ansible_local.dhparam|d() and
                                       ansible_local.dhparam[postfix__dhparam_set]|d())
                                   else "" }}'
                                                                   # ]]]
# .. envvar:: postfix__no_log [[[
#
# This variable can be used in the Ansible tasks to set the ``no_log``
# parameter. Changing it to ``False`` can help with debugging issues with the
# roles, but otherwise it should be set to ``True`` to ensure that Ansible
# doesn't leak sensitive data in its logs.
postfix__no_log: True
                                                                   # ]]]
                                                                   # ]]]
# LDAP authentication [[[
# --------------------------

# .. envvar:: postfix__ldap_enabled [[[
#
# Enable or disable support for LDAP authentication in Postfix.
# It is disabled by default in order to define a single Mail Relay Server.
postfix__ldap_enabled: 'False'

                                                                   # ]]]
# .. envvar:: postfix__ldap_base_dn [[[
#
# The base Distinguished Name which should be used to create Distinguished
# Names of the LDAP directory objects, defined as a YAML list. If this variable
# is empty, automated Postfix LDAP configuration will not be performed.
postfix__ldap_base_dn: '{{ ansible_local.ldap.base_dn
                            if (ansible_local|d() and ansible_local.ldap|d() and
                                ansible_local.ldap.base_dn|d())
                            else [] }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_device_dn [[[
#
# The Distinguished Name of the current host LDAP object, defined as a YAML
# list. It will be used as a base for the Postfix service account LDAP
# object. If the list is empty, the role will not create the account LDAP
# object automatically.
postfix__ldap_device_dn: '{{ ansible_local.ldap.device_dn
                              if (ansible_local|d() and ansible_local.ldap|d() and
                                  ansible_local.ldap.device_dn|d())
                              else [] }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_self_rdn [[[
#
# The Relative Distinguished Name of the account LDAP object used by the
# Postfix service to access the LDAP directory.
postfix__ldap_self_rdn: 'uid=postfix'

                                                                   # ]]]
# .. envvar:: postfix__ldap_self_object_classes [[[
#
# List of the LDAP object classes which will be used to create the LDAP object
# used by the nextcloudFIXME service to access the LDAP directory.
postfix__ldap_self_object_classes: [ 'account', 'simpleSecurityObject' ]

                                                                   # ]]]
# .. envvar:: postfix__ldap_self_attributes [[[
#
# YAML dictionary that defines the attributes of the LDAP object used by the
# Postfix service to access the LDAP directory.
postfix__ldap_self_attributes:
  uid: '{{ postfix__ldap_self_rdn.split("=")[1] }}'
  userPassword: '{{ postfix__ldap_bindpw }}'
  host: '{{ [ ansible_fqdn, ansible_hostname ] | unique }}'
  description: 'Account used by the "Postfix" service to access the LDAP directory'

                                                                   # ]]]
# .. envvar:: postfix__ldap_binddn [[[
#
# The Distinguished Name of the account LDAP object used by the
# Postfix service to bind to the LDAP directory.
postfix__ldap_binddn: '{{ ([ postfix__ldap_self_rdn ] + postfix__ldap_device_dn) | join(",") }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_bindpw [[[
#
# The password stored in the account LDAP object used by the Postfix service
# to bind to the LDAP directory.
postfix__ldap_bindpw: '{{ lookup("password", secret + "/ldap/credentials/"
                                  + postfix__ldap_binddn | to_uuid + ".password length=32 "
                                  + "chars=alpha,digits,!@_#$%^&*") }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_people_rdn [[[
#
# The Relative Distinguished Name of the LDAP object which contains the user
# accounts stored in LDAP.
postfix__ldap_people_rdn: '{{ ansible_local.ldap.people_rdn
                               if (ansible_local|d() and ansible_local.ldap|d() and
                                   ansible_local.ldap.people_rdn|d())
                               else "ou=People" }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_people_dn [[[
#
# The Distinguished Name of the LDAP object which contains the user accounts
# used by Postfix.
postfix__ldap_people_dn: '{{ [ postfix__ldap_people_rdn ] + postfix__ldap_base_dn }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_uri [[[
#
# List of LDAP URIs that point to the directory servers which should be used by
# nextcloudFIXME.
postfix__ldap_uri: '{{ (ansible_local.ldap.uri
                    if (ansible_local|d() and ansible_local.ldap|d() and
                        ansible_local.ldap.uri|d())
                    else [""]) | first }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_private_groups [[[
#
# When this variable is enabled, the :ref:`debops.ldap` role will create
# a separate LDAP objects that manage the Postfix groups as subtree of the
# DokiWiki service LDAP object. If you set this parameter to ``False``, the
# role will use the global ``ou=Groups,dc=example,dc=org`` subtree instead.
postfix__ldap_private_groups: True

                                                                   # ]]]
# .. envvar:: postfix__ldap_groups_rdn [[[
#
# The Relative Distinguished Name of the LDAP object which contains the groups
# stored in LDAP.
postfix__ldap_groups_rdn: '{{ ansible_local.ldap.groups_rdn
                               if (ansible_local|d() and ansible_local.ldap|d() and
                                   ansible_local.ldap.groups_rdn|d())
                               else "ou=Groups" }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_domains_rdn [[[
#
# The Relative Distinguished Name of the LDAP object which contains the (virtual mail)
# domains stored in LDAP.
postfix__ldap_domains_rdn: '{{ ansible_local.ldap.domains_rdn
                               if (ansible_local|d() and ansible_local.ldap|d() and
                                   ansible_local.ldap.domains_rdn|d())
                               else "ou=Domains" }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_groups_dn [[[
#
# The Distinguished Name of the LDAP object which contains the groups used by
# Postfix. If private groups are enabled, this object will be created
# automatically.
postfix__ldap_groups_dn: '{{ ([ postfix__ldap_groups_rdn, postfix__ldap_self_rdn ]
                               + postfix__ldap_device_dn)
                              if postfix__ldap_private_groups|bool
                              else ([ postfix__ldap_groups_rdn ] + postfix__ldap_base_dn) }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_domains_dn [[[
#
# The Distinguished Name of the LDAP object which contains the (virtual mail) domains used by
# Postfix. If private groups are enabled, this object will be created
# automatically.
postfix__ldap_domains_dn: '{{ ([ postfix__ldap_domains_rdn, postfix__ldap_self_rdn ]
                               + postfix__ldap_device_dn)
                              if postfix__ldap_private_groups|bool
                              else ([ postfix__ldap_domains_rdn ] + postfix__ldap_base_dn) }}'
                                                                   # ]]]
# .. envvar:: postfix__ldap_default_virtual_domain_rdn [[[
#
# The rdn of the default virtual mail domain used by Postfix.
# This is usually the same domain used by the LDAP.
postfix__ldap_default_virtual_domain_rdn: '{{ ansible_domain }}'
                                                                   # ]]]
# .. envvar:: postfix__ldap_default_virtual_domain_dn [[[
#
# The dn of the default virtual mail domain used by Postfix.
postfix__ldap_default_virtual_domain_dn: '{{ (["dc=" + postfix__ldap_default_virtual_domain_rdn]
                                              + postfix__ldap_domains_dn) | join(",") }}'
                                                                   # ]]]
                                                                   # ]]]

# LDAP connection options [[[
# ---------------------------

# .. envvar:: postfix__ldap_server_uri [[[
#
# The URI address of the LDAP server used by Postfix.
postfix__ldap_server_uri: '{{ (ansible_local.ldap.uri
                                if (ansible_local|d() and ansible_local.ldap|d() and
                                    ansible_local.ldap.uri|d())
                                else [""]) | first }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_server_port [[[
#
# The TCP port which should be used for connections to the LDAP server.
postfix__ldap_server_port: '{{ ansible_local.ldap.port
                                if (ansible_local|d() and ansible_local.ldap|d() and
                                    ansible_local.ldap.port|d())
                                else ("389" if postfix__ldap_start_tls|bool else "636") }}'

                                                                   # ]]]
# .. envvar:: postfix__ldap_start_tls [[[
#
# If ``True``, Postfix will use STARTTLS extension to make encrypted
# connections to the LDAP server.
postfix__ldap_start_tls: '{{ ansible_local.ldap.start_tls
                              if (ansible_local|d() and ansible_local.ldap|d() and
                                  (ansible_local.ldap.start_tls|d())|bool)
                              else True }}'

                                                                   # ]]]
                                                                   # ]]]

# Advanced settings [[[
# ---------------------

# .. envvar:: postfix__ldap_user_filter [[[
#
# The LDAP filter used to look up user accounts in the directory.
postfix__ldap_user_filter: '(&
                               (objectClass=inetOrgPerson)
                               (objectClass=postfixUser)
                             )
                             (mailEnabled=TRUE)
                             (|
                               (authorizedService=postfix)
                               (authorizedService=mail)
                               (authorizedService=\*)
                             )'

                                                                   # ]]]
# .. envvar:: postfix__ldap_domain_filter [[[
#
# The LDAP filter used to look up user accounts in the directory.
postfix__ldap_domain_filter: '(&
                                (ObjectClass=dNSDomain)
                                (dc=%s)
                               )'

                                                                   # ]]]
                                                                   # ]]]

# Expert settings [[[
# ------------------

# .. envvar:: postfix__ldap_quota_attribute [[[
#
# Set the LDAP attribute value to be read by Postfix in order to get the user quota.
postfix__ldap_quota_attribute: 'mailQuota'
                                                                   # ]]]
# .. envvar:: postfix__ldap_quota_default [[[
#
# User default LDAP quota. Use human-readable values, e.g. "2 GB".
postfix__ldap_quota_default: '10 GB'
                                                                   # ]]]
# .. envvar:: postfix__ldap_default_config [[[
#
# The LDAP configuration options defined by default.
postfix__ldap_default_config: []

                                                                   # ]]]
# .. envvar:: postfix__ldap_config [[[
#
# List of custom LDAP configuration options defined for all hosts
# in the Ansible inventory.
postfix__ldap_config: []
                                                                   # ]]]

# .. envvar:: postfix__group_ldap_config [[[
#
# List of custom LDAP configuration options defined on hosts in
# a specific Ansible inventory group.
postfix__group_ldap_config: []
                                                                   # ]]]

# .. envvar:: postfix__host_ldap_config [[[
#
# List of custom LDAP configuration options defined on specific
# hosts in the Ansible inventory.
postfix__host_ldap_config: []
                                                                   # ]]]

# .. envvar:: postfix__ldap_combined_config [[[
#
# The variable that combines default and user LDAP configuration and is used in
# the role tasks and templates.
postfix__ldap_combined_config: '{{ postfix__ldap_default_config
                                    + postfix__ldap_config
                                    + postfix__group_ldap_config
                                    + postfix__host_ldap_config }}'
                                                                   # ]]]

# (LDAP) Virtual Mail settings  [[[
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
# All mailboxes are stored directly in the file system of the server.
# See :ref:`postfix__virtual_mailbox_base` for more details.
# For the accesses to the mailbox directories a separate user "vmail" ("Virtual Mail") is created,
# under which the accesses of Postfix, Dovecot and other components of the mail server should take place.
# On the one hand this prevents mail server components from accessing sensitive system directories,
# on the other hand it protects the mailboxes from external access.
# Only vmail (and root) are allowed to access the mailboxes.

# .. envvar:: postfix__virtual_mail_posix_user [[[
#
# Virtual Mail POSIX username
postfix__virtual_mail_posix_user: 'vmail'
                                                                   # ]]]
# .. envvar:: postfix__virtual_mail_posix_uidnumber [[[
#
# Virtual Mail POSIX uidNumber
postfix__virtual_mail_posix_uidnumber: 5000
                                                                   # ]]]
# .. envvar:: postfix__virtual_mail_posix_group [[[
#
# Virtual Mail POSIX group
postfix__virtual_mail_posix_group: 'vmail'
                                                                   # ]]]
# .. envvar:: postfix__virtual_mail_posix_gidnumber [[[
#
# Virtual Mail POSIX gidNumber
postfix__virtual_mail_posix_gidnumber: 5000
                                                                   # ]]]
# .. envvar:: postfix__virtual_mailbox_base [[[
#
# A prefix that the virtual delivery agent prepends to all pathname results from
#  $virtual_mailbox_maps table lookups.
# The directories under this base contain the users MailDirs.
# This directory must be created in advance and must be writeable by all potential mail users.
# To achieve this, either use the same GID across all mail users and set group ownership to that GID,
# or make the directory world writable.
postfix__virtual_mailbox_base: '/var/vmail'
                                                                   # ]]]
# .. envvar:: postfix__virtual_alias_maps [[[
#
# Optional lookup tables that alias specific mail addresses or domains
# to other local or remote address. #
# The default option, when using Virtual Mail with LDAP, will first go over the
# alisaes set by :ref:`debops.etc_aliases` and if no match is found query
# the LDAP for the email address.
#
# Specify zero or more "type:name" lookup tables, separated by whitespace or comma.
# Tables will be searched in the specified order until a match is found.
# Note: these lookups are recursive.
postfix__virtual_alias_maps:
  - '$alias_maps'
  - 'ldap:/etc/postfix/ldap/virtual_aliases.cf'
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
# Postfix 'main.cf' configuration [[[
# -----------------------------------

# These variables define the contents of the :file:`/etc/postfix/main.cf`
# configuration file. See :ref:`postfix__ref_maincf` for more details.

# .. envvar:: postfix__original_maincf [[[
#
# List of options defined by the Debian ``postfix`` package when the default
# "Internet Site" configuration type is selected during installation. This list
# is used as the base configuration.
postfix__original_maincf:

  - name: 'myorigin_example'
    option: 'myorigin'
    value: '/etc/mailname'
    comment: |
      Debian specific:  Specifying a file name will cause the first
      line of that file to be used as the name.  The Debian default
      is /etc/mailname.
    state: 'comment'
    section: 'base'

  - name: 'smtpd_banner'
    value: '$myhostname ESMTP $mail_name (Debian/GNU)'
    section: 'base'

  - name: 'biff'
    value: False
    section: 'base'

  - name: 'append_dot_mydomain'
    value: False
    comment: "appending .domain is the MUA's job."
    section: 'base'

  - name: 'delay_warning_time'
    value: '4h'
    comment: 'Uncomment the next line to generate "delayed mail" warnings'
    state: 'comment'
    section: 'base'

  - name: 'readme_directory'
    value: '{{ "/usr/share/doc/postfix"
               if postfix__doc_installed|bool
               else False }}'
    section: 'base'

  - name: 'compatibility_level'
    value: 2
    comment: |
      See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on
      fresh installs.
    section: 'base'
    state: '{{ "present"
               if (postfix__version is version_compare("3.0.0", ">="))
               else "ignore" }}'

  - name: 'smtpd_tls_cert_file'
    value: '{{ postfix__tls_cert_file }}'
    comment: 'TLS parameters'
    section: 'base'

  - name: 'smtpd_tls_key_file'
    value: '{{ postfix__tls_key_file }}'
    section: 'base'

  - name: 'smtpd_use_tls'
    value: True
    section: 'base'

  - name: 'smtpd_tls_session_cache_database'
    value: 'btree:${data_directory}/smtpd_scache'
    section: 'base'

  - name: 'smtp_tls_session_cache_database'
    value: 'btree:${data_directory}/smtp_scache'
    section: 'base'

  - name: 'smtp_tls_client_comment'
    comment: |
      See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
      information on enabling SSL in the smtp client.
    state: 'hidden'
    section: 'base'

  - name: 'smtpd_relay_restrictions'
    section: 'base'
    state: '{{ "present"
               if (postfix__version is version_compare("2.10.0", ">="))
               else "ignore" }}'
    value:

      - name: 'permit_mynetworks'
        weight: -300

      - name: 'permit_sasl_authenticated'
        weight: -200

      - name: 'defer_unauth_destination'
        weight: -100

  - name: 'myhostname'
    value: '{{ postfix__fqdn }}'
    section: 'base'

  - name: 'alias_maps'
    value: [ 'hash:/etc/aliases' ]
    section: 'base'

  - name: 'alias_database'
    value: [ 'hash:/etc/aliases' ]
    section: 'base'

  - name: 'myorigin'
    value: '/etc/mailname'
    section: 'base'

  - name: 'mydestination'
    section: 'base'
    value:

      - '{{ postfix__fqdn }}'

      - name: 'localhost.{{ postfix__domain }}'
        weight: 190

      - name: 'localhost'
        weight: 200

  - name: 'relayhost'
    value: '{{ postfix__relayhost }}'
    section: 'base'

  - name: 'mynetworks'
    section: 'base'
    value:

      - name: '127.0.0.0/8'
        weight: 100

      - name: '::ffff:127.0.0.0/104'
        weight: 100

      - name: '::1/128'
        weight: 100

  - name: 'mailbox_size_limit'
    value: 0
    section: 'base'

  - name: 'recipient_delimiter'
    value: '+'
    section: 'base'

  - name: 'inet_interfaces'
    value: 'all'
    section: 'base'

  - name: 'inet_protocols'
    value: 'all'
    section: 'base'
    state: '{{ "present"
               if (ansible_distribution_release == "stretch")
               else "ignore" }}'

  - name: 'html_directory'
    value: '{{ "/usr/share/doc/postfix/html"
               if postfix__doc_installed|bool
               else False }}'
    section: 'base'

                                                                   # ]]]
# .. envvar:: postfix__default_maincf [[[
#
# The list of Postfix :file:`/etc/postfix/main.cf` configuration file options
# defined by default by the ``debops.postfix`` Ansible role.
postfix__default_maincf:

  - name: 'smtpd_banner'
    value: '$myhostname ESMTP'

  - name: 'enable_long_queue_ids'
    value: True
    section: 'base'
    state: '{{ "present"
               if (postfix__version is version_compare("2.9.0", ">="))
               else "ignore" }}'

                                                                   # ]]]
# .. envvar:: postfix__tls_maincf [[[
#
# The list of Postfix :file:`/etc/postfix/main.cf` configuration file options
# defined by default by the ``debops.postfix`` Ansible role which configure
# TLS/SSL encryption.
postfix__tls_maincf:

  - name: 'smtp_tls_client_comment'
    state: 'absent'

  - name: 'smtpd_use_tls'
    section: 'smtpd-tls'
    weight: -500

  - name: 'smtpd_tls_cert_file'
    section: 'smtpd-tls'
    comment: ''

  - name: 'smtpd_tls_key_file'
    section: 'smtpd-tls'

  - name: 'smtpd_tls_CAfile'
    value: '{{ postfix__tls_ca_file }}'
    section: 'smtpd-tls'

  - name: 'smtp_tls_CAfile'
    value: '{{ postfix__tls_ca_file }}'
    section: 'smtp-tls'

  - name: 'lmtp_tls_CAfile'
    value: '{{ postfix__tls_ca_file }}'
    section: 'lmtp-tls'

  - name: 'smtpd_tls_session_cache_database'
    section: 'smtpd-tls'

  - name: 'smtp_tls_session_cache_database'
    section: 'smtp-tls'

  - name: 'lmtp_tls_session_cache_database'
    value: 'btree:${data_directory}/lmtp_scache'
    section: 'lmtp-tls'

  - name: 'smtpd_tls_dh1024_param_file'
    value: '{{ postfix__tls_dh1024_param_file }}'
    state: '{{ "present" if postfix__dhparam|bool else "ignore" }}'
    section: 'smtpd-tls'

  - name: 'smtpd_tls_dh512_param_file'
    value: '{{ postfix__tls_dh512_param_file }}'
    state: '{{ "present" if postfix__dhparam|bool else "ignore" }}'
    section: 'smtpd-tls'

  - name: 'smtpd_tls_loglevel'
    value: 1
    section: 'smtpd-tls'

  - name: 'smtp_tls_loglevel'
    value: 1
    section: 'smtp-tls'

  - name: 'lmtp_tls_loglevel'
    value: 1
    section: 'lmtp-tls'

  - name: 'smtpd_tls_security_level'
    value: 'may'
    section: 'smtpd-tls'
    weight: -500

  - name: 'smtp_tls_security_level'
    value: 'may'
    section: 'smtp-tls'
    weight: -500

  - name: 'lmtp_tls_security_level'
    value: 'may'
    section: 'lmtp-tls'
    weight: -500

  - name: 'smtpd_tls_auth_only'
    value: True
    section: 'smtpd-tls'

  - name: 'smtpd_tls_protocols'
    value: [ '!SSLv2', '!SSLv3', '!TLSv1', 'TLSv1.1', 'TLSv1.2' ]
    section: 'smtpd-tls'

  - name: 'smtp_tls_protocols'
    value: [ '!SSLv2', '!SSLv3', '!TLSv1', 'TLSv1.1', 'TLSv1.2' ]
    section: 'smtp-tls'

  - name: 'lmtp_tls_protocols'
    value: [ '!SSLv2', '!SSLv3', '!TLSv1', 'TLSv1.1', 'TLSv1.2' ]
    section: 'lmtp-tls'

  - name: 'smtpd_tls_mandatory_protocols'
    value: [ '!SSLv2', '!SSLv3', '!TLSv1', 'TLSv1.1', 'TLSv1.2' ]
    section: 'smtpd-tls'

  - name: 'smtp_tls_mandatory_protocols'
    value: [ '!SSLv2', '!SSLv3', '!TLSv1', 'TLSv1.1', 'TLSv1.2' ]
    section: 'smtp-tls'

  - name: 'lmtp_tls_mandatory_protocols'
    value: [ '!SSLv2', '!SSLv3', '!TLSv1', 'TLSv1.1', 'TLSv1.2' ]
    section: 'lmtp-tls'

  - name: 'smtpd_tls_ciphers'
    value: 'high'
    section: 'smtpd-tls'

  - name: 'smtp_tls_ciphers'
    value: 'high'
    section: 'smtp-tls'

  - name: 'lmtp_tls_ciphers'
    value: 'high'
    section: 'lmtp-tls'

  - name: 'smtpd_tls_mandatory_ciphers'
    value: 'high'
    section: 'smtpd-tls'

  - name: 'smtp_tls_mandatory_ciphers'
    value: 'high'
    section: 'smtp-tls'

  - name: 'lmtp_tls_mandatory_ciphers'
    value: 'high'
    section: 'lmtp-tls'

  - name: 'smtpd_tls_exclude_ciphers'
    value: [ 'aNULL', 'RC4', 'MD5', 'DES', '3DES', 'RSA', 'SHA' ]
    section: 'smtpd-tls'

  - name: 'smtp_tls_exclude_ciphers'
    value: [ 'aNULL', 'RC4', 'MD5', 'DES', '3DES', 'RSA', 'SHA' ]
    section: 'smtp-tls'

  - name: 'lmtp_tls_exclude_ciphers'
    value: [ 'aNULL', 'RC4', 'MD5', 'DES', '3DES', 'RSA', 'SHA' ]
    section: 'lmtp-tls'

  - name: 'smtpd_tls_eecdh_grade'
    value: 'ultra'
    section: 'smtpd-tls'

  - name: 'smtpd_tls_received_header'
    value: True
    section: 'smtpd-tls'

  - name: 'smtp_tls_note_starttls_offer'
    value: True
    section: 'smtp-tls'

  - name: 'lmtp_tls_note_starttls_offer'
    value: True
    section: 'lmtp-tls'

  - name: 'tls_preempt_cipherlist'
    value: True
    section: 'tls'

  - name: 'tls_ssl_options'
    value: 'NO_COMPRESSION'
    section: 'tls'
    state: '{{ "present"
            if (postfix__version is version_compare("2.11.0", ">="))
            else "ignore" }}'

  # Postfix is final destination for the specified list of virtual alias domains,
  # that is, domains for which all addresses are aliased to addresses in other local or remote domains
  - name: 'virtual_alias_domains'
    value: 'ldap:/etc/postfix/ldap/virtual_alias_domains'
    section: 'virtual'
    state: '{{ "absent"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # Postfix is final destination for the specified list of domains; mail is delivered
  # via the $virtual_transport mail delivery transport
  - name: 'virtual_mailbox_domains'
    value: 'ldap:/etc/postfix/ldap/virtual_domains.cf'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # Optional lookup tables that alias specific mail addresses or domains to other local or remote address.
  - name: 'virtual_alias_maps'
    value: '{{ postfix__virtual_alias_maps | join(",") }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  #A prefix that the virtual delivery agent prepends to all pathname results from $virtual_mailbox_maps table lookups.
  # This is a safety measure to ensure that an out of control map doesn't litter the file system with mailboxes.
  - name: 'virtual_mailbox_base'
    value: '{{ postfix__virtual_mailbox_base }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # Optional lookup tables with all valid addresses in the domains that match $virtual_mailbox_domains.
  - name: 'virtual_mailbox_maps'
    value: 'ldap:/etc/postfix/ldap/virtual_recipients.cf'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # Lookup tables with the per-recipient user ID that the virtual delivery agent uses while writing
  # to the recipient's mailbox.
  - name: 'virtual_uid_maps'
    value: 'static:{{ postfix__virtual_mail_posix_uidnumber }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # Lookup tables with the per-recipient group ID for virtual mailbox delivery.
  - name: 'virtual_gid_maps'
    value: 'static:{{ postfix__virtual_mail_posix_gidnumber }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # The minimum user ID value that the virtual delivery agent accepts as a result from $virtual_uid_maps table lookup
  - name: 'virtual_minimum_uid'
    value: '{{ postfix__virtual_mail_posix_uidnumber }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool and postfix__version is version_compare("2.0", ">="))
            else "ignore" }}'

  # Optional lookup table with the SASL login names that own the sender (MAIL FROM) addresses.
  - name: 'smtpd_sender_login_maps'
    value: 'ldap:/etc/postfix/ldap/virtual_senders.cf'
    section: 'base'
    state: '{{ "present"
            if (postfix__ldap_enabled|bool)
            else "ignore" }}'
                                                                   # ]]]
# .. envvar:: postfix__restrictions_maincf [[[
#
# The list of Postfix :file:`/etc/postfix/main.cf` configuration file options
# defined by default by the ``debops.postfix`` Ansible role which configure
# mail relay and delivery restrictions.
postfix__restrictions_maincf:

  - name: 'smtpd_helo_required'
    value: True
    section: 'restrictions'

  - name: 'strict_rfc821_envelopes'
    value: True
    section: 'restrictions'

  - name: 'smtpd_reject_unlisted_sender'
    value: True
    section: 'restrictions'

  - name: 'disable_vrfy_command'
    value: True
    section: 'restrictions'

  - name: 'smtpd_client_restrictions'
    section: 'restrictions'
    weight: 10
    separator: True

  - name: 'smtpd_helo_restrictions'
    section: 'restrictions'
    weight: 20
    value:

      - name: 'permit_mynetworks'
        weight: -400

      - name: 'reject_invalid_helo_hostname'
        weight: -300

      - name: 'reject_non_fqdn_helo_hostname'
        weight: -200

      - name: 'reject_unknown_helo_hostname'
        weight: -100

  - name: 'smtpd_sender_restrictions'
    section: 'restrictions'
    weight: 30
    value:

      - name: 'reject_non_fqdn_sender'
        weight: -200

      - name: 'reject_unknown_sender_domain'
        weight: -100

  - name: 'smtpd_relay_restrictions'
    section: 'restrictions'
    copy_id_from: 'smtpd_sender_restrictions'
    weight: 40
    state: '{{ "present"
               if (postfix__version is version_compare("2.10.0", ">="))
               else "ignore" }}'

  - name: 'smtpd_recipient_restrictions'
    section: 'restrictions'
    weight: 50
    value:

      - name: 'reject_non_fqdn_recipient'
        weight: -200
      - name: 'reject_unknown_recipient_domain'
        weight: -100

  - name: 'smtpd_data_restrictions'
    section: 'restrictions'
    weight: 60
    value:

      - name: 'reject_unauth_pipelining'
        weight: -200
      - name: 'reject_multi_recipient_bounce'
        weight: -100

                                                                   # ]]]
# .. envvar:: postfix__maincf [[[
#
# The list of Postfix :file:`/etc/postfix/main.cf` configuration file options
# which should be present on all hosts in the Ansible inventory.
postfix__maincf: []

                                                                   # ]]]
# .. envvar:: postfix__group_maincf [[[
#
# The list of Postfix :file:`/etc/postfix/main.cf` configuration file options
# which should be present on hosts in the specific Ansible inventory group.
postfix__group_maincf: []

                                                                   # ]]]
# .. envvar:: postfix__host_maincf [[[
#
# The list of Postfix :file:`/etc/postfix/main.cf` configuration file options
# which should be present on specific hosts in the Ansible inventory.
postfix__host_maincf: []

                                                                   # ]]]
# .. envvar:: postfix__dependent_maincf [[[
#
# List of the :file:`/etc/postfix/main.cf` configuration options defined by
# other roles through role dependent variables. The configuration syntax
# differs from a normal :file:`main.cf` configuration,
# see :ref:`postfix__ref_dependency` for more details.
postfix__dependent_maincf: []

                                                                   # ]]]
# .. envvar:: postfix__dependent_maincf_filter [[[
#
# The filtered configuration from other roles passed via role dependent
# variables. This variable should be included in the combined list of
# :file:`main.cf` configuration options. See :ref:`postfix__ref_dependency`
# for more details.
postfix__dependent_maincf_filter: '{{ lookup("template",
                                              "lookup/postfix__dependent_maincf_filter.j2")
                                              | from_yaml }}'

                                                                   # ]]]
# .. envvar:: postfix__combined_maincf [[[
#
# List which combines all of the :file:`main.cf`-related variables and is used
# in the configuration template.
postfix__combined_maincf: '{{ postfix__original_maincf
                              + postfix__default_maincf
                              + postfix__tls_maincf
                              + postfix__restrictions_maincf
                              + postfix__dependent_maincf_filter
                              + postfix__maincf
                              + postfix__group_maincf
                              + postfix__host_maincf }}'

                                                                   # ]]]
# .. envvar:: postfix__init_maincf [[[
#
# This variable contains initial state of :file:`main.cf` configuration options
# based on the contents of `:envvar:`postfix__combined_maincf` variable. It's
# used to dynamically assign Postfix options to configuration file sections in
# case that a section is not specified.
postfix__init_maincf: '{{ lookup("template",
                          "lookup/postfix__init_maincf.j2") }}'

                                                                   # ]]]
# .. envvar:: postfix__maincf_sections [[[
#
# List of configuration sections which are defined in the
# :file:`/etc/postfix/main.cf` configuration file.
# See :ref:`postfix__ref_maincf_sections` for more details.
postfix__maincf_sections:

  - name: 'base'

  - name: 'auth'
    title: 'Authentication and authorization'

  - name: 'route'
    title: 'Message routing'

  - name: 'virtual'
    title: 'Virtual mail configuration'

  - name: 'tls'
    title: 'TLS/SSL configuration'

  - name: 'smtpd-tls'
    title: 'SMTP Server (smtpd) TLS configuration'

  - name: 'smtp-tls'
    title: 'SMTP Client (smtp) TLS configuration'

  - name: 'lmtp-tls'
    title: 'Local Mail Transfer Protocol (lmtp) TLS configuration'

  - name: 'postscreen'
    title: 'postscreen options'

  - name: 'restrictions'
    title: 'SMTP Server (smtpd) restrictions'

  - name: 'filter'
    title: 'Mail filtering configuration'

  - name: 'limit'
    title: 'Rate limits'

  - name: 'unknown'
    title: 'Other options'
                                                                   # ]]]
                                                                   # ]]]
# Postfix 'master.cf' configuration [[[
# -------------------------------------

# These variables define the contents of the :file:`/etc/postfix/master.cf`
# configuration file. See :ref:`postfix__ref_mastercf` for more details.

# .. envvar:: postfix__original_mastercf [[[
#
# List of options defined by the Debian ``postfix`` package when the default
# "Internet Site" configuration type is selected during installation. This list
# is used as the base configuration.
postfix__original_mastercf:

  - name: 'smtp'
    type: 'inet'
    private: False
    chroot: True
    command: 'smtpd'

  - name: 'postscreen'
    service: 'smtp'
    type: 'inet'
    private: False
    chroot: True
    maxproc: 1
    command: 'postscreen'
    state: 'comment'

  - name: 'smtpd'
    type: 'pass'
    chroot: True
    state: 'comment'

  - name: 'dnsblog'
    type: 'unix'
    chroot: True
    maxproc: 0
    state: 'comment'

  - name: 'tlsproxy'
    type: 'unix'
    chroot: True
    maxproc: 0
    state: 'comment'

  - name: 'submission'
    type: 'inet'
    private: False
    chroot: True
    command: 'smtpd'
    state: 'comment'
    options:

      - syslog_name: 'postfix/submission'
      - smtpd_tls_security_level: 'encrypt'
      - smtpd_sasl_auth_enable: True
      - smtpd_reject_unlisted_recipient: False

      - name: 'smtpd_client_restrictions'
        value: '$mua_client_restrictions'
        state: 'comment'

      - name: 'smtpd_helo_restrictions'
        value: '$mua_helo_restrictions'
        state: 'comment'

      - name: 'smtpd_sender_restrictions'
        value: '$mua_sender_restrictions'
        state: 'comment'

      - smtpd_recipient_restrictions: ''

      - name: 'smtpd_relay_restrictions'
        value: [ 'permit_sasl_authenticated', 'reject' ]
        state: '{{ "present"
                  if (postfix__version is version_compare("2.10.0", ">="))
                  else "ignore" }}'

      - milter_macro_daemon_name: 'ORIGINATING'

  - name: 'smtps'
    type: 'inet'
    private: False
    chroot: True
    command: 'smtpd'
    state: 'comment'
    options:

      - syslog_name: 'postfix/smtps'
      - smtpd_tls_wrappermode: True
      - smtpd_sasl_auth_enable: True
      - smtpd_reject_unlisted_recipient: False

      - name: 'smtpd_client_restrictions'
        value: '$mua_client_restrictions'
        state: 'comment'

      - name: 'smtpd_helo_restrictions'
        value: '$mua_helo_restrictions'
        state: 'comment'

      - name: 'smtpd_sender_restrictions'
        value: '$mua_sender_restrictions'
        state: 'comment'

      - smtpd_recipient_restrictions: ''

      - name: 'smtpd_relay_restrictions'
        value: [ 'permit_sasl_authenticated', 'reject' ]
        state: '{{ "present"
                  if (postfix__version is version_compare("2.10.0", ">="))
                  else "ignore" }}'

      - milter_macro_daemon_name: 'ORIGINATING'

  - name: 'qmqp'
    service: '628'
    type: 'inet'
    private: False
    chroot: True
    command: 'qmqpd'
    state: 'comment'

  - name: 'pickup'
    type: 'unix'
    private: False
    chroot: True
    wakeup: 60
    maxproc: 1

  - name: 'cleanup'
    type: 'unix'
    private: False
    chroot: True
    maxproc: 0

  - name: 'qmgr'
    type: 'unix'
    private: False
    chroot: False
    wakeup: 300
    maxproc: 1

  - name: 'oqmgr'
    service: 'qmgr'
    type: 'unix'
    private: False
    chroot: False
    wakeup: 300
    maxproc: 1
    command: 'oqmgr'
    state: 'comment'

  - name: 'tlsmgr'
    type: 'unix'
    chroot: True
    wakeup: '1000?'
    maxproc: 1

  - name: 'rewrite'
    type: 'unix'
    chroot: True
    command: 'trivial-rewrite'

  - name: 'bounce'
    type: 'unix'
    chroot: True
    maxproc: 0

  - name: 'defer'
    type: 'unix'
    chroot: True
    maxproc: 0
    command: 'bounce'

  - name: 'trace'
    type: 'unix'
    chroot: True
    maxproc: 0
    command: 'bounce'

  - name: 'verify'
    type: 'unix'
    chroot: True
    maxproc: 1

  - name: 'flush'
    type: 'unix'
    private: False
    chroot: True
    wakeup: '1000?'
    maxproc: 0

  - name: 'proxymap'
    type: 'unix'
    chroot: False

  - name: 'proxywrite'
    type: 'unix'
    chroot: False
    maxproc: 1
    command: 'proxymap'

  - name: 'smtp_unix'
    service: 'smtp'
    type: 'unix'
    chroot: True
    command: 'smtp'

  - name: 'relay'
    type: 'unix'
    chroot: True
    command: 'smtp'
    options:

      - name: 'smtp_helo_timeout'
        value: 5
        state: 'comment'

      - name: 'smtp_connect_timeout'
        value: 5
        state: 'comment'

  - name: 'showq'
    type: 'unix'
    chroot: True
    private: False

  - name: 'error'
    type: 'unix'
    chroot: True

  - name: 'retry'
    type: 'unix'
    chroot: True
    command: 'error'

  - name: 'discard'
    type: 'unix'
    chroot: True

  - name: 'local'
    type: 'unix'
    unpriv: False
    chroot: False

  - name: 'virtual'
    type: 'unix'
    unpriv: False
    chroot: False

  - name: 'lmtp'
    type: 'unix'
    chroot: True

  - name: 'anvil'
    type: 'unix'
    chroot: True
    maxproc: 1

  - name: 'scache'
    type: 'unix'
    chroot: True
    maxproc: 1

  - name: 'non-postfix-sftware'
    comment: |
      ====================================================================
      Interfaces to non-Postfix software. Be sure to examine the manual
      pages of the non-Postfix software to find out what options it wants.

      Many of the following services use the Postfix pipe(8) delivery
      agent.  See the pipe(8) man page for information about ${recipient}
      and other message envelope options.
      ====================================================================
    state: 'hidden'

  - name: 'maildrop'
    comment: |
      maildrop. See the Postfix MAILDROP_README file for details.
      Also specify in main.cf: maildrop_destination_recipient_limit=1
    type: 'unix'
    unpriv: False
    chroot: False
    command: 'pipe'
    args: 'flags=DRhu user=vmail argv=/usr/bin/maildrop -d ${recipient}'

  - name: 'cyrus-lmtp-note'
    comment: |
      ====================================================================

      Recent Cyrus versions can use the existing "lmtp" master.cf entry.

      Specify in cyrus.conf:
        lmtp    cmd="lmtpd -a" listen="localhost:lmtp" proto=tcp4

      Specify in main.cf one or more of the following:
       mailbox_transport = lmtp:inet:localhost
       virtual_transport = lmtp:inet:localhost

      ====================================================================
    state: 'hidden'

  - name: 'cyrus'
    comment: |
      Cyrus 2.1.5 (Amos Gouaux)
      Also specify in main.cf: cyrus_destination_recipient_limit=1
    type: 'unix'
    unpriv: False
    chroot: False
    command: 'pipe'
    args: 'user=cyrus argv=/cyrus/bin/deliver -e -r ${sender} -m ${extension} ${user}'
    state: 'comment'

  - name: 'old-cyrus'
    comment: |
      ====================================================================
      Old example of delivery via Cyrus.
    type: 'unix'
    unpriv: False
    chroot: False
    command: 'pipe'
    args: 'flags=R user=cyrus argv=/cyrus/bin/deliver -e -m ${extension} ${user}'
    state: 'comment'

  - name: 'uucp'
    comment: |
      ====================================================================

      See the Postfix UUCP_README file for configuration details.
    type: 'unix'
    unpriv: False
    chroot: False
    command: 'pipe'
    args: 'flags=Fqhu user=uucp argv=uux -r -n -z -a$sender - $nexthop!rmail ($recipient)'

  - name: 'other-delivery-methods'
    comment: 'Other external delivery methods.'
    state: 'hidden'

  - name: 'ifmail'
    type: 'unix'
    unpriv: False
    chroot: False
    command: 'pipe'
    args: 'flags=F user=ftn argv=/usr/lib/ifmail/ifmail -r $nexthop ($recipient)'

  - name: 'bsmtp'
    type: 'unix'
    unpriv: False
    chroot: False
    command: 'pipe'
    args: 'flags=Fq. user=bsmtp argv=/usr/lib/bsmtp/bsmtp -t$nexthop -f$sender $recipient'

  - name: 'scalemail-backend'
    type: 'unix'
    unpriv: False
    chroot: False
    maxproc: 2
    command: 'pipe'
    args: 'flags=R user=scalemail argv=/usr/lib/scalemail/bin/scalemail-store ${nexthop} ${user} ${extension}'

  - name: 'mailman'
    type: 'unix'
    unpriv: False
    chroot: False
    args: |
      flags=FR user=list argv=/usr/lib/mailman/bin/postfix-to-mailman.py
      ${nexthop} ${user}
    command: 'pipe'

                                                                   # ]]]
# .. envvar:: postfix__default_mastercf [[[
#
# The list of Postfix :file:`/etc/postfix/master.cf` configuration file options
# defined by default by the ``debops.postfix`` Ansible role.
postfix__default_mastercf: []

                                                                   # ]]]
# .. envvar:: postfix__tls_mastercf [[[
#
# The list of Postfix :file:`/etc/postfix/master.cf` configuration file options
# defined by default by the ``debops.postfix`` Ansible role which configure
# TLS/SSL encryption.
postfix__tls_mastercf:

  - name: 'submission'
    options:
      - tls_preempt_cipherlist: True

  - name: 'smtps'
    options:
      - tls_preempt_cipherlist: True

                                                                   # ]]]
# .. envvar:: postfix__mastercf [[[
#
# The list of Postfix :file:`/etc/postfix/master.cf` configuration file options
# which should be present on all hosts in the Ansible inventory.
postfix__mastercf: []

                                                                   # ]]]
# .. envvar:: postfix__group_mastercf [[[
#
# The list of Postfix :file:`/etc/postfix/master.cf` configuration file options
# which should be present on hosts in the specific Ansible inventory group.
postfix__group_mastercf: []

                                                                   # ]]]
# .. envvar:: postfix__host_mastercf [[[
#
# The list of Postfix :file:`/etc/postfix/master.cf` configuration file options
# which should be present on specific hosts in the Ansible inventory.
postfix__host_mastercf: []

                                                                   # ]]]
# .. envvar:: postfix__dependent_mastercf [[[
#
# List of the :file:`/etc/postfix/master.cf` configuration options defined by
# other roles through role dependent variables. The configuration syntax
# differs from a normal :file:`master.cf` configuration,
# see :ref:`postfix__ref_dependency` for more details.
postfix__dependent_mastercf: []

                                                                   # ]]]
# .. envvar:: postfix__dependent_mastercf_filter [[[
#
# The filtered configuration from other roles passed via role dependent
# variables. This variable should be included in the combined list of
# :file:`master.cf` configuration options. See :ref:`postfix__ref_dependency`
# for more details.
postfix__dependent_mastercf_filter: '{{ lookup("template",
                                               "lookup/postfix__dependent_mastercf_filter.j2")
                                               | from_yaml }}'

                                                                   # ]]]
# .. envvar:: postfix__combined_mastercf [[[
#
# List which combines all of the :file:`master.cf`-related variables and is used
# in the configuration template.
postfix__combined_mastercf: '{{ postfix__original_mastercf
                                + postfix__default_mastercf
                                + postfix__tls_mastercf
                                + postfix__dependent_mastercf_filter
                                + postfix__mastercf
                                + postfix__group_mastercf
                                + postfix__host_mastercf }}'
                                                                   # ]]]
                                                                   # ]]]
# Postfix lookup tables [[[
# -------------------------

# These variables define the contents of the various Postfix lookup tables
# which will be placed in the :file:`/etc/postfix/` directory.
# See :ref:`postfix__ref_lookup_tables` for more details.

# .. envvar:: postfix__lookup_tables [[[
#
# List of lookup tables which will be managed on all hosts in the Ansible
# inventory.
postfix__lookup_tables: []

                                                                   # ]]]
# .. envvar:: postfix__group_lookup_tables [[[
#
# List of lookup tables which will be managed on hosts in specific Ansible
# inventory group.
postfix__group_lookup_tables: []

                                                                   # ]]]
# .. envvar:: postfix__host_lookup_tables [[[
#
# List of lookup tables which will be managed on specific hosts in the Ansible
# inventory.
postfix__host_lookup_tables: []

                                                                   # ]]]
# .. envvar:: postfix__dependent_lookup_tables [[[
#
# List of lookup tables which are defined by other Ansible roles through role
# dependent variables.
postfix__dependent_lookup_tables: []

                                                                   # ]]]
# .. envvar:: postfix__dependent_lookup_tables_filter [[[
#
# This variable filters the configuration defined by other Ansible roles to be
# usable with the rest of the lookup tables configuration.
postfix__dependent_lookup_tables_filter: '{{ lookup("flattened",
                                             postfix__dependent_lookup_tables) }}'

                                                                   # ]]]
# .. envvar:: postfix__combined_lookup_tables [[[
#
# Variable which combines all lookup table lists and passes them to the Ansible
# tasks. It also defines the order in which the entries are processed.
postfix__combined_lookup_tables: '{{ ([ postfix__dependent_lookup_tables_filter ]
                                      if postfix__dependent_lookup_tables_filter is mapping
                                      else postfix__dependent_lookup_tables_filter)
                                     + postfix__lookup_tables
                                     + postfix__group_lookup_tables
                                     + postfix__host_lookup_tables }}'
                                                                   # ]]]
                                                                   # ]]]
# Configuration for other Ansible roles [[[
# -----------------------------------------

# .. envvar:: postfix__ferm__dependent_rules [[[
#
# Configuration for the :ref:`debops.ferm` Ansible role.
postfix__ferm__dependent_rules:

  - name: 'postfix_smtp'
    type: 'accept'
    by_role: 'debops.postfix'
    dport: [ 'smtp' ]
    saddr: '{{ postfix__allow_smtp }}'
    accept_any: '{{ postfix__accept_any }}'
    rule_state: '{{ "present"
                    if ("smtp" in postfix__env_active_services|d([]))
                    else "absent" }}'

  - name: 'postfix_smtps'
    type: 'accept'
    by_role: 'debops.postfix'
    dport: [ 'smtps' ]
    saddr: '{{ postfix__allow_smtps }}'
    accept_any: '{{ postfix__accept_any }}'
    rule_state: '{{ "present"
                    if ("smtps" in postfix__env_active_services|d([]))
                    else "absent" }}'

  - name: 'postfix_submission'
    type: 'accept'
    by_role: 'debops.postfix'
    dport: [ 'submission' ]
    saddr: '{{ postfix__allow_submission }}'
    accept_any: '{{ postfix__accept_any }}'
    rule_state: '{{ "present"
                    if ("submission" in postfix__env_active_services|d([]))
                    else "absent" }}'
                                                                   # ]]]
# .. envvar:: postfix__ldap__dependent_tasks [[[
#
# Configuration for the :ref:`debops.ldap` Ansible role.
postfix__ldap__dependent_tasks:

  - name: 'Create Postfix account for {{ postfix__ldap_device_dn | join(",") }}'
    dn: '{{ postfix__ldap_binddn }}'
    objectClass: '{{ postfix__ldap_self_object_classes }}'
    attributes: '{{ postfix__ldap_self_attributes }}'
    no_log: '{{ postfix__no_log|d(True) }}'
    state: '{{ "present"
                if (postfix__ldap_enabled|bool and
                    postfix__ldap_device_dn|d())
                else "ignore" }}'

  - name: 'Create Postfix group container for {{ postfix__ldap_device_dn | join(",") }}'
    dn: '{{ postfix__ldap_groups_dn }}'
    objectClass: 'organizationalUnit'
    attributes:
      ou: '{{ postfix__ldap_groups_rdn.split("=")[1] }}'
      description: 'User groups used in Postfix'
    state: '{{ "present"
               if (postfix__ldap_enabled|bool and
                   postfix__ldap_device_dn|d() and
                   postfix__ldap_private_groups|bool)
               else "ignore" }}'

  - name: 'Create Postfix domains container for {{ postfix__ldap_device_dn | join(",") }}'
    dn: '{{ postfix__ldap_domains_dn }}'
    objectClass: 'organizationalUnit'
    attributes:
      ou: '{{ postfix__ldap_domains_rdn.split("=")[1] }}'
      description: 'Virtual Mail Domains used in Postfix'
    state: '{{ "present"
               if (postfix__ldap_enabled|bool and
                   postfix__ldap_device_dn|d() and
                   postfix__ldap_private_groups|bool)
               else "ignore" }}'

  - name: 'Create Postfix Default Virtual Mail Domain for {{ postfix__ldap_default_virtual_domain_dn }}'
    dn: '{{ postfix__ldap_default_virtual_domain_dn }}'
    objectClass: 'dNSDomain'
    state: '{{ "present"
               if (postfix__ldap_enabled|bool and
                   postfix__ldap_device_dn|d() and
                   postfix__ldap_private_groups|bool)
               else "ignore" }}'


                                                                   # ]]]
# .. envvar:: postfix__ldap_dependent_system_users [[[
#
# Configuration for the :ref:`debops.system_users` Ansible role.
postfix__ldap_dependent_system_users:

  - name: '{{ postfix__virtual_mail_posix_user }}'
    group: '{{ postfix__virtual_mail_posix_group }}'
    uid: '{{ postfix__virtual_mail_posix_uidnumber }}'
    gid: '{{ postfix__virtual_mail_posix_gidnumber }}'
    system: True
    comment: 'Postfix Virtual Mail user'
    shell: '/usr/sbin/nologin'
    home: '{{ postfix__virtual_mailbox_base }}'
    skeleton: null
    state: 'present'
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
