---

- name: Configure APT autoremove options
  template:
    src: 'etc/apt/apt.conf.d/25autoremove-recommends.conf.j2'
    dest: '/etc/apt/apt.conf.d/25autoremove-recommends.conf'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: apt_mark__enabled|bool

- name: Check state of the APT packages
  vars:
    script_src: '{{ "apt-mark-status.py2"
                    if (ansible_python_version is version_compare("3.5", "<"))
                    else "apt-mark-status" }}'
  script: 'script/{{ script_src }}'
  register: apt_mark__register_state
  changed_when: False
  check_mode: False
  when: apt_mark__enabled|bool

- name: Set facts about APT package state
  set_fact:
    apt_mark__fact_auto:      '{{ (apt_mark__register_state.stdout|from_json)["auto"] }}'
    apt_mark__fact_hold:      '{{ (apt_mark__register_state.stdout|from_json)["hold"] }}'
    apt_mark__fact_installed: '{{ (apt_mark__register_state.stdout|from_json)["installed"] }}'
    apt_mark__fact_manual:    '{{ (apt_mark__register_state.stdout|from_json)["manual"] }}'
  when: apt_mark__enabled|bool

- name: Set package state as installed automatically
  command: apt-mark auto {{ ((item.packages | d([ item.name ])) | intersect(apt_mark__fact_installed)) | join(' ') }}
  with_items: '{{ apt_mark__combined_packages | parse_kv_items }}'
  when: (apt_mark__enabled|bool and
         (item.packages|d([ item.name ]) | intersect(apt_mark__fact_installed)) | symmetric_difference(apt_mark__fact_manual) and
         (item.packages|d([ item.name ]) | intersect(apt_mark__fact_installed)) | difference(apt_mark__fact_auto) and
         item.state|d('manual') in [ 'auto', 'auto-hold', 'auto-unhold' ])

- name: Set package state as installed manually
  command: apt-mark manual {{ ((item.packages | d([ item.name ])) | intersect(apt_mark__fact_installed)) | join(' ') }}
  with_items: '{{ apt_mark__combined_packages | parse_kv_items }}'
  when: (apt_mark__enabled|bool and
         (item.packages|d([ item.name ]) | intersect(apt_mark__fact_installed)) | symmetric_difference(apt_mark__fact_auto) and
         (item.packages|d([ item.name ]) | intersect(apt_mark__fact_installed)) | difference(apt_mark__fact_manual) and
         item.state|d('manual') in [ 'manual', 'manual-hold', 'manual-unhold' ])

- name: Hold current package state
  command: apt-mark hold {{ ((item.packages | d([ item.name ])) | intersect(apt_mark__fact_installed)) | join(' ') }}
  with_items: '{{ apt_mark__combined_packages | parse_kv_items }}'
  when: (apt_mark__enabled|bool and
        (item.packages|d([ item.name ]) | intersect(apt_mark__fact_installed)) | difference(apt_mark__fact_hold) and
        item.state|d('manual') in [ 'hold', 'auto-hold', 'manual-hold' ])

- name: Unhold current package state
  command: apt-mark unhold {{ ((item.packages | d([ item.name ])) | intersect(apt_mark__fact_installed)) | join(' ') }}
  with_items: '{{ apt_mark__combined_packages | parse_kv_items }}'
  when: (apt_mark__enabled|bool and
        (item.packages|d([ item.name ]) | intersect(apt_mark__fact_installed)) | intersect(apt_mark__fact_hold) and
        item.state|d('manual') in [ 'unhold', 'auto-unhold', 'manual-unhold' ])

- name: Configure local facts
  import_tasks: local_facts.yml

- name: Update Ansible facts if they were modified
  action: setup
  when: local_facts__register_facts is changed
