# Copyright (C) 2020 Pedro Luis Lopez <pedroluis.lopezsanchez@gmail.com>
# Copyright (C) 2020 DebOps <https://debops.org/>
# SPDX-License-Identifier: GPL-3.0-or-later

# {{ ansible_managed }}

{% set prometheus_exporter__tpl_args = [] %}
{% for element in prometheus_exporter__combined_args | parse_kv_items %}
{%   if element.name|d() and element.state|d('present') not in [ 'absent', 'ignore' ] %}
{%     if element.name in [ 'common', item.name ] and element.options|d() %}
{%       for thing in element.options %}
{%         if thing.name|d() and thing.value|d() and thing.state|d('present') != 'absent' %}
{%           if thing.value is iterable and thing.value is not string %}
{%             for value in thing.value %}
{%               set _ = prometheus_exporter__tpl_args.append('--{}={}'.format(thing.name, value.name)) %}
{%             endfor %}
{%           else %}
{%             set _ = prometheus_exporter__tpl_args.append('--{}={}'.format(thing.name, thing.value)) %}
{%           endif %}
{%         endif %}
{%       endfor %}
{%     endif %}
{%   endif %}
{% endfor %}
# Set the command-line arguments to pass to the server.
ARGS="{{ prometheus_exporter__tpl_args | join(' ') }}"
{% for element in prometheus_exporter__env | parse_kv_items %}
{%   if element.name|d() and element.state|d('present') not in [ 'absent', 'ignore' ] %}
{%     if element.name == item.name and element.options|d() %}
{%       for thing in element.options %}
{%         if thing.name|d() and thing.value|d() and thing.state|d('present') != 'absent' %}
{{ thing.name + "=" + thing.value }}
{%         endif %}
{%       endfor %}
{%     endif %}
{%   endif %}
{% endfor %}
