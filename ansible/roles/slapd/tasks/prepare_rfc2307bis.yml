---
# Copyright (C) 2016-2019 Maciej Delmanowski <drybjed@gmail.com>
# Copyright (C) 2016-2025 DebOps <https://debops.org/>
# SPDX-License-Identifier: GPL-3.0-only

- name: Install APT packages required for rfc2307bis
  ansible.builtin.package:
    name: '{{ slapd__rfc2307bis_packages  }}'
    state: 'present'
  register: slapd__register_rfc2307bis
  until: slapd__register_rfc2307bis is succeeded

- name: Ensure that DebOps schema directory exists
  ansible.builtin.file:
    path: '{{ slapd__debops_schema_path }}'
    state: 'directory'
    mode: '0755'

- name: Copy custom DebOps rf2307bis schemas to the OpenLDAP host
  ansible.builtin.copy:
    src: 'etc/ldap/schema/debops/rfc2307bis.schema'
    dest: '{{ slapd__debops_schema_path + "/" }}'
    mode: '0644'

- name: Divert the original NIS schema included in Debian
  debops.debops.dpkg_divert:
    path: '/etc/ldap/schema/{{ item }}'
  loop:
    - 'nis.schema'
    - 'nis.ldif'

- name: Convert rfc2307bis schema to ldif
  ansible.builtin.shell: schema2ldif rfc2307bis.schema > rfc2307bis.ldif
  args:
    creates: '{{ slapd__debops_schema_path + "/rfc2307bis.ldif" }}'
    chdir: '{{ slapd__debops_schema_path }}'

- name: Symlink the new rfc2307bis schema in place of NIS schema
  ansible.builtin.file:
    state: 'link'
    path: '/etc/ldap/schema/{{ item | replace("rfc2307bis", "nis") }}'
    src: '{{ slapd__debops_schema_path + "/" + item }}'
    mode: '0644'
  loop: [ 'rfc2307bis.schema', 'rfc2307bis.ldif' ]
  when: not ansible_check_mode | bool
