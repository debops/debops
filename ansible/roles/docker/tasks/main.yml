---

- name: Install required packages
  apt:
    name: '{{ (docker__mandatory_packages
               + docker__base_packages
               + docker__packages) | flatten }}'
    state: 'present'
    install_recommends: False
  register: docker__register_packages
  until: docker__register_packages is succeeded

- name: Ensure /root/.docker/ exists
  file:
    path: '/root/.docker'
    state: 'directory'
    mode: '0755'
  when: docker__pki|bool

- name: Symlink certificate files to /root/.docker/
  file:
    path: '/root/.docker/{{ item.dest }}'
    src: '{{ item.src }}'
    state: 'link'
  with_items:
    - dest: 'ca.pem'
      src: '{{ docker__pki_ca_path }}'
    - dest: 'cert.pem'
      src: '{{ docker__pki_crt_path }}'
    - dest: 'key.pem'
      src: '{{ docker__pki_key_path }}'
  when: docker__pki|bool

- name: Manage Docker components
  include: 'manage_components.yml'
  tags: [ 'role::docker:components', 'skip::docker:components' ]
