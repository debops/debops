---
# Copyright (C) 2021 David HÃ¤rdeman <david@hardeman.nu>
# SPDX-License-Identifier: GPL-3.0-only

- name: Stop nscd/unscd/nslcd daemons
  systemd:
    name: '{{ item }}'
    state: 'stopped'
    enabled: 'no'
  loop:
    - 'unscd'
    - 'nscd'
    - 'nslcd'
  failed_when: False

- name: Purge nscd/unscd/nslcd packages
  apt:
    name: '{{ item }}'
    state: 'absent'
    purge: 'yes'
  loop:
    - 'unscd'
    - 'nscd'
    - 'nslcd'
    - 'nslcd-utils'
    - 'libpam-ldapd'
    - 'libnss-ldapd'

- name: Undo nscd configuration file diversion
  command: dpkg-divert --quiet --local --remove /etc/nscd.conf

- name: Purge config files
  file:
    path: '{{ item }}'
    state: 'absent'
  loop:
    - '/etc/nscd.conf'
    - '/etc/nscd.conf.dpkg-divert'
    - '/etc/ansible/facts.d/nscd.fact'
    - '/etc/nslcd.conf'
    - '/etc/ansible/facts.d/nslcd.fact'
    - '/run/nscd/socket'

# FIXME: Remove LDAP entries?
