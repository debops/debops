{# Copyright (C) 2021 Pedro Luis Lopez <pedroluis.lopezsanchez@gmail.com>
 # Copyright (C) 2021 DebOps <https://debops.org/>
 # SPDX-License-Identifier: GPL-3.0-only
 #}
# {{ ansible_managed }}

{% set ghostunnel__tpl_configuration = {} %}
{% for key, value in ghostunnel__default_configuration.items() %}
{%   set _ = ghostunnel__tpl_configuration.update({key: value}) %}
{% endfor %}
{% for key, value in ghostunnel__configuration.items() %}
{%   set _ = ghostunnel__tpl_configuration.update({key: value}) %}
{% endfor %}
{% for key, value in item.items() %}
{%   set _ = ghostunnel__tpl_configuration.update({key: value}) %}
{% endfor %}
{% set ghostunnel__tpl_args = [] %}
{% for key, value in ghostunnel__tpl_configuration.items() %}
{%   if key not in [ 'name', 'mode', 'allow' ] %}
{%       if value is iterable and value is not string %}
{%         for thing in value %}
{%           set _ = ghostunnel__tpl_args.append('--{} {}'.format(key|replace('_','-'), thing)) %}
{%         endfor %}
{%       elif value is string %}
{%         set _ = ghostunnel__tpl_args.append('--{} {}'.format(key|replace('_','-'), value)) %}
{%       elif value %}
{%         set _ = ghostunnel__tpl_args.append('--{}'.format(key|replace('_','-'))) %}
{%       endif %}
{%   endif %}
{% endfor %}
# Set the command-line arguments to pass to the service.
ARGS="{{ ghostunnel__tpl_args | join(' ') }}"
{% if not item.disable_authentication | d(False) %}
CERT_PATH="{{ ghostunnel__pki_path + "/" + ghostunnel__pki_realm + "/" + ghostunnel__pki_crt }}"
KEY_PATH="{{ ghostunnel__pki_path + "/" + ghostunnel__pki_realm + "/" + ghostunnel__pki_key }}"
CACERT_PATH="{{ ghostunnel__pki_path + "/" + ghostunnel__pki_realm + "/" + ghostunnel__pki_ca }}"
{% endif %}
