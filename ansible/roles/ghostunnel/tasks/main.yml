---
# Copyright (C) 2021 Pedro Luis Lopez <pedroluis.lopezsanchez@gmail.com>
# Copyright (C) 2021 DebOps <https://debops.org/>
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Create Ghostunnel system group
  group:
    name: '{{ ghostunnel__group }}'
    state: 'present'
    system: True

- name: Create Ghostunnel system user
  user:
    name: '{{ ghostunnel__user }}'
    group: '{{ ghostunnel__group }}'
    groups: '{{ ghostunnel__combined_append_groups | join(",") | default(omit) }}'
    home: '/var/lib/ghostunnel'
    comment: 'Ghostunnel,,,'
    shell: '/bin/false'
    state: 'present'
    system: True

- name: Configure Ghostunnel services
  template:
    src: 'etc/default/ghostunnel.j2'
    dest: '/etc/default/ghostunnel-{{ item.name }}'
    owner: '{{ ghostunnel__user }}'
    group: '{{ ghostunnel__group }}'
    mode: '0640'
  with_items:
    - '{{ ghostunnel__combined_services }}'
  tags: [ 'role::ghostunnel:config' ]
  notify: Restart ghostunnel services

- name: Generate Ghostunnel services systemd service unit
  template:
    src: 'etc/systemd/system/ghostunnel.service.j2'
    dest: '/etc/systemd/system/ghostunnel-{{ item.name }}.service'
    owner: 'root'
    group: 'root'
    mode: '0644'
  register: ghostunnel__register_services_systemd_services
  with_items:
    - '{{ ghostunnel__combined_services }}'
  notify: Restart ghostunnel services

- name: Reload systemd daemons
  systemd:
    daemon_reload: True
  when: ghostunnel__register_services_systemd_services is changed

- name: Enable Ghostunnel services systemd services
  service:
    name: 'ghostunnel-{{ item.name }}.service'
    enabled: True
  with_items:
    - '{{ ghostunnel__combined_services }}'

- name: Make sure that Ansible local facts directory exists
  file:
    path: '/etc/ansible/facts.d'
    state: 'directory'
    mode: '0755'

- name: Save Ghostunnel local facts
  template:
    src: 'etc/ansible/facts.d/ghostunnel.fact.j2'
    dest: '/etc/ansible/facts.d/ghostunnel.fact'
    mode: '0755'
  register: ghostunnel__register_facts

- name: Update Ansible facts if they were modified
  action: setup
  when: ghostunnel__register_facts is changed
